{% extends "layouts/base.html" %}

{%- block title -%}{{ release.project.display_name }} {{ version_name }} ~ ATR{%- endblock title -%}

{%- block description -%}Review page for the {{ release.project.display_name }} {{ version_name }} candidate{%- endblock description -%}

{% block stylesheets %}
  {{ super() }}
  <style>
    .page-table-striped-odd {
      background-color: #eeeeee;
    }

    .page-icon-cell {
      width: 2em;
      text-align: center;
    }

    table tr {
      border-bottom: none;
    }

    #poll-progress-container {
      height: 6px;
    }

    @keyframes poll-grow {
      from {
        width: 0%;
      }

      to {
        width: 100%;
      }
    }
  </style>
{% endblock stylesheets %}

{% block content %}
  {% set phase = release.phase.value %}
  <p class="d-flex justify-content-between align-items-center">
    <a href="{{ as_url(get.root.index) }}" class="atr-back-link">← Back to Select a release</a>
    <span>
      {% if phase == "release_candidate_draft" %}
        <strong class="atr-phase-one atr-phase-symbol">①</strong>
        <span class="atr-phase-one atr-phase-label">COMPOSE</span>
        <span class="atr-phase-arrow">→</span>
        <span class="atr-phase-symbol-other">②</span>
      {% else %}
        <span class="atr-phase-symbol-other">①</span>
        <span class="atr-phase-arrow">→</span>
        <strong class="atr-phase-two atr-phase-symbol">②</strong>
        <span class="atr-phase-two atr-phase-label">VOTE</span>
      {% endif %}
      <span class="atr-phase-arrow">→</span>
      <span class="atr-phase-symbol-other">③</span>
    </span>
  </p>

  {% if phase == "release_candidate_draft" %}
    <h1>
      Compose <strong>{{ release.project.short_display_name }}</strong> <em>{{ release.version }}</em>
    </h1>
    <p>
      Manage the <strong>candidate draft</strong> for {{ release.project.display_name }} {{ version_name }}. Add files, review checks, and promote when ready.
    </p>
  {% else %}
    <h1>
      Vote on <strong>{{ release.project.short_display_name }}</strong> <em>{{ release.version }}</em>
    </h1>
    {% if release.podling_thread_id %}
      <p class="fs-3 mb-4">Second round of voting</p>
    {% elif release.committee.is_podling %}
      <p class="fs-3 mb-4">First round of voting</p>
    {% endif %}
    <p>
      The
      {% if release.podling_thread_id %}
        Incubator
      {% else %}
        {{ release.committee.display_name }}
      {% endif %}
      committee is currently voting on the <strong>release candidate</strong> for {{ release.project.display_name }} {{ version_name }}. This page allows you to review the automated checks run on the files in the release.
    </p>
  {% endif %}

  {% include "check-selected-release-info.html" %}

  <div id="ongoing-tasks-banner"
       class="alert alert-warning{% if ongoing_tasks_count == 0 %} d-none{% endif %}"
       role="alert"
       {% if revision_number %}data-api-url="/api/checks/ongoing/{{ release.project.name }}/{{ release.version }}/{{ revision_number }}"{% endif %}>
    <i class="bi bi-exclamation-triangle me-2"></i>
    <span id="ongoing-tasks-text">There {{ 'is' if ongoing_tasks_count == 1 else 'are' }} currently <strong id="ongoing-tasks-count">{{ ongoing_tasks_count }}</strong> background verification {{ 'task' if ongoing_tasks_count == 1 else 'tasks' }} running for the latest revision. Results shown below may be incomplete or outdated until the tasks finish.</span>
    <div id="poll-progress-container" class="progress mt-2">
      <div id="poll-progress" class="progress-bar bg-warning"></div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        Files
        {% if phase == "release_candidate_draft" %}
          in this revision
        {% else %}
          in the release candidate
        {% endif %}
      </h5>
    </div>
    <div class="card-body">
      {% if paths|length > 0 %}
        {% include "check-selected-path-table.html" %}

      {% else %}
        <div class="alert alert-info">This draft does not have any files yet.</div>
      {% endif %}
    </div>
  </div>
  {% if phase == "release_candidate_draft" %}
    <p>
      <a class="btn btn-primary"
         href="{{ as_url(get.distribution.stage, project=release.project.name, version=release.version) }}">Record a distribution</a>
    </p>
    <h2 id="more-actions">More actions</h2>
    <h3 id="ignored-checks" class="mt-4">Ignored checks</h3>
    {% if info.ignored_errors or info.ignored_warnings %}
      {% set ignored_errors_count = info.ignored_errors|length %}
      {% set ignored_warnings_count = info.ignored_warnings|length %}
      <p>
        There were {{ ignored_errors_count }} {{ 'error' if ignored_errors_count == 1 else 'errors' }} and {{ ignored_warnings_count }} {{ 'warning' if ignored_warnings_count == 1 else 'warnings' }} ignored by policy set by committee members. This does not include archive member checks.
      </p>
      <details>
        <summary>Show ignored checks</summary>
        <table class="table table-bordered border mb-3">
          <thead class="table-light">
            <tr>
              <th scope="col">
                Check
                <br />
                Path
              </th>
              <th scope="col">Message</th>
              <th scope="col">Status</th>
            </tr>
          </thead>
          <tbody>
            {% for ignored_result in info.ignored_errors %}
              <tr>
                <td class="text-nowrap">
                  {{ ignored_result.checker }}
                  <br />
                  {{ ignored_result.primary_rel_path }}
                </td>
                <td>{{ ignored_result.message }}</td>
                <td class="text-nowrap">{{ ignored_result.status.value|title }}</td>
              </tr>
            {% endfor %}
            {% for ignored_result in info.ignored_warnings %}
              <tr>
                <td class="text-nowrap">
                  {{ ignored_result.checker }}
                  <br />
                  {{ ignored_result.primary_rel_path }}
                </td>
                <td>{{ ignored_result.message }}</td>
                <td class="text-nowrap">{{ ignored_result.status.value|title }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </details>
    {% else %}
      <p>No ignored checks found.</p>
    {% endif %}
    <p>
      You can also <a href="{{ as_url(get.ignores.ignores, committee_name=release.committee.name) }}">manage which check results are ignored</a>.
    </p>

    <h3 id="debugging" class="mt-4">Debugging</h3>
    <div class="mb-2">
      <p>The following form is for debugging purposes only. It will create a new revision.</p>
    </div>
    <div class="mb-3">{{ empty_form|safe }}</div>

    <h3 id="delete-draft" class="mt-4">Delete this draft</h3>
    <p>Permanently delete this release candidate draft and all associated files. This action cannot be undone.</p>
    <div id="delete-draft-form">{{ delete_form|safe }}</div>
  {% endif %}
  {% if phase == "release_candidate" %}
    {% include "check-selected-candidate-forms.html" %}

  {% endif %}
{% endblock content %}

{% block javascripts %}
  {{ super() }}
  <script src="{{ static_url('js/ongoing-tasks-poll.js') }}"></script>
{% endblock javascripts %}
