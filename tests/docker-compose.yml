services:
  atr:
    build:
      context: ..
      dockerfile: Dockerfile.alpine
    environment:
      - ALLOW_TESTS=1
      - APP_HOST=atr:8080
      - BIND=0.0.0.0:8080
      - SECRET_KEY=insecure-test-key
      - SSH_HOST=0.0.0.0
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://127.0.0.1:8080/"]
      interval: 2s
      timeout: 1s
      retries: 30
      start_period: 10s

  atr-dev:
    build:
      context: ..
      dockerfile: Dockerfile.alpine
    environment:
      - ALLOW_TESTS=1
      - APP_HOST=atr-dev:8080
      - BIND=0.0.0.0:8080
      - SECRET_KEY=insecure-test-key
      - SSH_HOST=0.0.0.0
    networks:
      - test-network
    volumes:
      - ../atr:/opt/atr/atr
      - ../start-dev.sh:/opt/atr/start-atr.sh
      - atr-dev-state:/opt/atr/state
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://127.0.0.1:8080/"]
      interval: 2s
      timeout: 1s
      retries: 30
      start_period: 10s

  e2e-dev:
    build:
      context: e2e
      dockerfile: ../Dockerfile.e2e
    depends_on:
      atr-dev:
        condition: service_healthy
    networks:
      - test-network
    command: pytest e2e/ -v
    environment:
      - ATR_BASE_URL=https://atr-dev:8080

  playwright:
    build:
      context: ../playwright
      dockerfile: ../tests/Dockerfile.playwright
    depends_on:
      atr:
        condition: service_healthy
    networks:
      - test-network
    command: python3 test.py --skip-slow
    environment:
      - ATR_BASE_URL=https://atr:8080

  e2e:
    build:
      context: e2e
      dockerfile: ../Dockerfile.e2e
    depends_on:
      atr:
        condition: service_healthy
    networks:
      - test-network
    command: pytest e2e/ -v
    environment:
      - ATR_BASE_URL=https://atr:8080

networks:
  test-network:
    driver: bridge

volumes:
  atr-dev-state:
